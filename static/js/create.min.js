(function(){var M,N,board_palette_dom,color_palette_dom,create_clone,draggable_item_clone,error_field,game_board,game_dom,game_grid,get_tetramino_data,get_tetramino_indices,i,item,l,len,nodes,outline_board,outline_dom,ref,remove_data,response_field,selected_color_icon,set_data,set_error,set_response,snap_targets,tetramino_click_handler,tetramino_color_click_handler;selected_color_icon=null;game_dom=document.querySelector("#game-container");game_board=game_dom.querySelector("table");game_grid=game_dom.querySelector(".outline-grid");outline_dom=document.querySelector("#outline");outline_board=outline_dom.querySelector("table");nodes=document.querySelectorAll(".node");N=outline_board.rows.length;M=outline_board.rows[0].cells.length;color_palette_dom=document.getElementById("color-palette");board_palette_dom=document.getElementById("board-palette");ref=color_palette_dom.getElementsByClassName("color-icon");for(l=0,len=ref.length;l<len;l++){item=ref[l];item.addEventListener("click",function(){if(selected_color_icon){selected_color_icon.classList.remove("selected");if(selected_color_icon===this){selected_color_icon=null;return}}this.classList.add("selected");return selected_color_icon=this})}remove_data=function(el,palette){var color_class,span;color_class=el.getAttribute("data-class");if(color_class){el.classList.remove(color_class);window.show_element(palette.querySelector(`.${color_class}`))}el.removeAttribute("data-class");el.removeAttribute("data-index");el.removeAttribute("data-name");span=el.querySelector("span");if(span){return span.innerHTML=""}};set_data=function(target,source,palette){var klass,name;remove_data(target,palette);if(source){klass=source.getAttribute("data-class");name=source.getAttribute("data-name");target.classList.add(klass);target.setAttribute("data-class",klass);target.setAttribute("data-index",source.getAttribute("data-index"));target.setAttribute("data-name",name);if(name){return target.querySelector("span").innerHTML=name}}};game_board.querySelectorAll("td").forEach(function(cell){return cell.addEventListener("click",function(){return remove_data(cell,board_palette_dom)})});draggable_item_clone=null;create_clone=function(source,click_listener=null){var clone;clone=source.cloneNode(true);clone.style.position="absolute";clone.style.left=source.offsetLeft+"px";clone.style.top=source.offsetTop+"px";if(click_listener){clone.addEventListener("click",click_listener)}source.after(clone);return clone};interact(".board-item").draggable({onstart:function(evt){return draggable_item_clone=create_clone(evt.target)},onmove:function(evt){var el,x,y;el=evt.target;x=(parseFloat(el.dataset.x)||0)+evt.dx;y=(parseFloat(el.dataset.y)||0)+evt.dy;el.style.transform=`translate(${x}px, ${y}px)`;el.dataset.x=x;return el.dataset.y=y},onend:function(evt){var el;el=evt.target;el.style.transform="";el.removeAttribute("data-x");el.removeAttribute("data-y");draggable_item_clone.remove();return draggable_item_clone=null}}).styleCursor(false);interact("#game-container td").dropzone({accept:".board-item",overlap:.75,ondrop:function(evt){var el,klass,selected_value;el=evt.target;selected_value=evt.relatedTarget;klass=selected_value.getAttribute("data-class");set_data(el,selected_value,board_palette_dom);if(game_dom.querySelectorAll(`.${klass}`).length>=4){return window.hide_element(selected_value)}}});tetramino_click_handler=function(){var angle;if(!this.classList.contains("snapped")){angle=parseInt(this.dataset.rotationAngle);if(angle>=270){this.classList.remove("animate");angle-=360;this.style.setProperty("--rotation",`${angle}deg`);this.offsetHeight;this.classList.add("animate")}this.dataset.rotationAngle=angle+90;return this.style.setProperty("--rotation",`${this.dataset.rotationAngle}deg`)}};tetramino_color_click_handler=function(){this.parentNode.querySelectorAll(".cell").forEach(function(c){return set_data(c,selected_color_icon,color_palette_dom)});if(selected_color_icon){window.hide_element(selected_color_icon);selected_color_icon.classList.remove("selected");return selected_color_icon=null}};document.querySelectorAll(".tetramino").forEach(function(t){if(!t.classList.contains("tet-O")){t.dataset.rotationAngle=0;return t.addEventListener("click",tetramino_click_handler)}});get_tetramino_data=function(el){var cell_size,col_array,range,ref1,ref10,ref11,ref12,ref13,ref14,ref15,ref16,ref17,ref18,ref19,ref2,ref20,ref21,ref22,ref23,ref24,ref25,ref26,ref27,ref28,ref29,ref3,ref30,ref31,ref32,ref33,ref34,ref35,ref36,ref37,ref38,ref39,ref4,ref40,ref41,ref42,ref5,ref6,ref7,ref8,ref9,rotation_angle,row_array;cell_size=parseFloat(getComputedStyle(el.querySelector(".cell")).width);range=cell_size/2;rotation_angle=(parseInt(el.dataset.rotationAngle)||0)%360;[row_array,col_array]=[null,null];if(el.classList.contains("tet-O")){[row_array,col_array]=[function(){var results=[];for(var m=0,ref1=N-1;0<=ref1?m<ref1:m>ref1;0<=ref1?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref2=M-1;0<=ref2?m<ref2:m>ref2;0<=ref2?m++:m--){results.push(m)}return results}.apply(this)]}else if(el.classList.contains("tet-I")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0;0<=N?m<N:m>N;0<=N?m++:m--){results.push(m)}return results}.apply(this),[0]]}else if(rotation_angle===90){[row_array,col_array]=[[0],function(){var results=[];for(var m=0;0<=M?m<M:m>M;0<=M?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0;0<=N?m<N:m>N;0<=N?m++:m--){results.push(m)}return results}.apply(this),[0]]}else if(rotation_angle===270){[row_array,col_array]=[[0],function(){var results=[];for(var m=0;0<=M?m<M:m>M;0<=M?m++:m--){results.push(m)}return results}.apply(this)]}}else if(el.classList.contains("tet-T")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0,ref3=N-1;0<=ref3?m<ref3:m>ref3;0<=ref3?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref4=M-2;0<=ref4?m<ref4:m>ref4;0<=ref4?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===90){[row_array,col_array]=[function(){var results=[];for(var m=0,ref5=N-2;0<=ref5?m<ref5:m>ref5;0<=ref5?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref6=M-1;0<=ref6?m<ref6:m>ref6;0<=ref6?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0,ref7=N-1;0<=ref7?m<ref7:m>ref7;0<=ref7?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref8=M-2;0<=ref8?m<ref8:m>ref8;0<=ref8?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===270){[row_array,col_array]=[function(){var results=[];for(var m=0,ref9=N-2;0<=ref9?m<ref9:m>ref9;0<=ref9?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref10=M-1;0<=ref10?m<ref10:m>ref10;0<=ref10?m++:m--){results.push(m)}return results}.apply(this)]}}else if(el.classList.contains("tet-L")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0,ref11=N-1;0<=ref11?m<ref11:m>ref11;0<=ref11?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref12=M-2;0<=ref12?m<ref12:m>ref12;0<=ref12?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===90){[row_array,col_array]=[function(){var results=[];for(var m=0,ref13=N-2;0<=ref13?m<ref13:m>ref13;0<=ref13?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref14=M-1;0<=ref14?m<ref14:m>ref14;0<=ref14?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0,ref15=N-1;0<=ref15?m<ref15:m>ref15;0<=ref15?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref16=M-2;0<=ref16?m<ref16:m>ref16;0<=ref16?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===270){[row_array,col_array]=[function(){var results=[];for(var m=0,ref17=N-2;0<=ref17?m<ref17:m>ref17;0<=ref17?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref18=M-1;0<=ref18?m<ref18:m>ref18;0<=ref18?m++:m--){results.push(m)}return results}.apply(this)]}}else if(el.classList.contains("tet-J")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0,ref19=N-1;0<=ref19?m<ref19:m>ref19;0<=ref19?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref20=M-2;0<=ref20?m<ref20:m>ref20;0<=ref20?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===90){[row_array,col_array]=[function(){var results=[];for(var m=0,ref21=N-2;0<=ref21?m<ref21:m>ref21;0<=ref21?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref22=M-1;0<=ref22?m<ref22:m>ref22;0<=ref22?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0,ref23=N-1;0<=ref23?m<ref23:m>ref23;0<=ref23?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref24=M-2;0<=ref24?m<ref24:m>ref24;0<=ref24?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===270){[row_array,col_array]=[function(){var results=[];for(var m=0,ref25=N-2;0<=ref25?m<ref25:m>ref25;0<=ref25?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref26=M-1;0<=ref26?m<ref26:m>ref26;0<=ref26?m++:m--){results.push(m)}return results}.apply(this)]}}else if(el.classList.contains("tet-S")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0,ref27=N-1;0<=ref27?m<ref27:m>ref27;0<=ref27?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref28=M-2;0<=ref28?m<ref28:m>ref28;0<=ref28?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===90){[row_array,col_array]=[function(){var results=[];for(var m=0,ref29=N-2;0<=ref29?m<ref29:m>ref29;0<=ref29?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref30=M-1;0<=ref30?m<ref30:m>ref30;0<=ref30?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0,ref31=N-1;0<=ref31?m<ref31:m>ref31;0<=ref31?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref32=M-2;0<=ref32?m<ref32:m>ref32;0<=ref32?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===270){[row_array,col_array]=[function(){var results=[];for(var m=0,ref33=N-2;0<=ref33?m<ref33:m>ref33;0<=ref33?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref34=M-1;0<=ref34?m<ref34:m>ref34;0<=ref34?m++:m--){results.push(m)}return results}.apply(this)]}}else if(el.classList.contains("tet-Z")){if(rotation_angle===0){[row_array,col_array]=[function(){var results=[];for(var m=0,ref35=N-1;0<=ref35?m<ref35:m>ref35;0<=ref35?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref36=M-2;0<=ref36?m<ref36:m>ref36;0<=ref36?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===90){[row_array,col_array]=[function(){var results=[];for(var m=0,ref37=N-2;0<=ref37?m<ref37:m>ref37;0<=ref37?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref38=M-1;0<=ref38?m<ref38:m>ref38;0<=ref38?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===180){[row_array,col_array]=[function(){var results=[];for(var m=0,ref39=N-1;0<=ref39?m<ref39:m>ref39;0<=ref39?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref40=M-2;0<=ref40?m<ref40:m>ref40;0<=ref40?m++:m--){results.push(m)}return results}.apply(this)]}else if(rotation_angle===270){[row_array,col_array]=[function(){var results=[];for(var m=0,ref41=N-2;0<=ref41?m<ref41:m>ref41;0<=ref41?m++:m--){results.push(m)}return results}.apply(this),function(){var results=[];for(var m=0,ref42=M-1;0<=ref42?m<ref42:m>ref42;0<=ref42?m++:m--){results.push(m)}return results}.apply(this)]}}return{row_array:row_array,col_array:col_array,cell_size:cell_size,range:range}};get_tetramino_indices=function(el,row,col){var cells,rotation_angle;rotation_angle=(parseInt(el.dataset.rotationAngle)||0)%360;cells=[];if(el.classList.contains("tet-O")){cells=[[row,col],[row,col+1],[row+1,col],[row+1,col+1]]}else if(el.classList.contains("tet-I")){if(rotation_angle===0){cells=[[row,col],[row,col+1],[row,col+2],[row,col+3]]}else if(rotation_angle===90){cells=[[row,col],[row+1,col],[row+2,col],[row+3,col]]}else if(rotation_angle===180){cells=[[row,col],[row,col+1],[row,col+2],[row,col+3]]}else if(rotation_angle===270){cells=[[row,col],[row+1,col],[row+2,col],[row+3,col]]}}else if(el.classList.contains("tet-T")){if(rotation_angle===0){cells=[[row,col],[row,col+1],[row,col+2],[row+1,col+1]]}else if(rotation_angle===90){cells=[[row,col+1],[row+1,col],[row+1,col+1],[row+2,col+1]]}else if(rotation_angle===180){cells=[[row,col+1],[row+1,col],[row+1,col+1],[row+1,col+2]]}else if(rotation_angle===270){cells=[[row,col],[row+1,col],[row+1,col+1],[row+2,col]]}}else if(el.classList.contains("tet-L")){if(rotation_angle===0){cells=[[row,col],[row,col+1],[row,col+2],[row+1,col]]}else if(rotation_angle===90){cells=[[row,col],[row,col+1],[row+1,col+1],[row+2,col+1]]}else if(rotation_angle===180){cells=[[row,col+2],[row+1,col],[row+1,col+1],[row+1,col+2]]}else if(rotation_angle===270){cells=[[row,col],[row+1,col],[row+2,col],[row+2,col+1]]}}else if(el.classList.contains("tet-J")){if(rotation_angle===0){cells=[[row,col],[row,col+1],[row,col+2],[row+1,col+2]]}else if(rotation_angle===90){cells=[[row+2,col],[row,col+1],[row+1,col+1],[row+2,col+1]]}else if(rotation_angle===180){cells=[[row,col],[row+1,col],[row+1,col+1],[row+1,col+2]]}else if(rotation_angle===270){cells=[[row,col],[row,col+1],[row+1,col],[row+2,col]]}}else if(el.classList.contains("tet-S")){if(rotation_angle===0){cells=[[row,col+1],[row,col+2],[row+1,col],[row+1,col+1]]}else if(rotation_angle===90){cells=[[row,col],[row+1,col],[row+1,col+1],[row+2,col+1]]}else if(rotation_angle===180){cells=[[row,col+1],[row,col+2],[row+1,col],[row+1,col+1]]}else if(rotation_angle===270){cells=[[row,col],[row+1,col],[row+1,col+1],[row+2,col+1]]}}else if(el.classList.contains("tet-Z")){if(rotation_angle===0){cells=[[row,col],[row,col+1],[row+1,col+1],[row+1,col+2]]}else if(rotation_angle===90){cells=[[row,col+1],[row+1,col],[row+1,col+1],[row+2,col]]}else if(rotation_angle===180){cells=[[row,col],[row,col+1],[row+1,col+1],[row+1,col+2]]}else if(rotation_angle===270){cells=[[row,col+1],[row+1,col],[row+1,col+1],[row+2,col]]}}return cells};snap_targets=function(index){var inner;inner=function(x,y,interaction){var c,data,el,i,idx,j,len1,len2,len3,m,o,offset_x,offset_y,outline_board_rect,p,r,ref1,ref2,ref3,table_left,table_top;offset_y=window.pageYOffset||document.documentElement.scrollTop;offset_x=window.pageXOffset||document.documentElement.scrollLeft;outline_board_rect=outline_board.getBoundingClientRect();table_top=outline_board_rect.top+offset_y;table_left=outline_board_rect.left+offset_x;el=interaction.element;data=get_tetramino_data(el);idx=0;ref1=data.row_array;for(m=0,len1=ref1.length;m<len1;m++){i=ref1[m];ref2=data.col_array;for(o=0,len2=ref2.length;o<len2;o++){j=ref2[o];if(index===idx){ref3=get_tetramino_indices(el,i,j);for(p=0,len3=ref3.length;p<len3;p++){[r,c]=ref3[p];if(outline_board.rows[r].cells[c].getAttribute("data-number")){return{x:Infinity,y:Infinity,range:data.range}}}return{x:table_left+j*data.cell_size,y:table_top+i*data.cell_size,range:data.range}}idx+=1}}};return inner};interact(".tetramino").draggable({onstart:function(evt){var el,number;el=evt.target;if(!el.classList.contains("snapped")){create_clone(el,tetramino_click_handler)}el.classList.remove("animate");el.style.setProperty("z-index",1e4);number=el.getAttribute("data-number");if(number){return outline_board.querySelectorAll(`[data-number='${number}']`).forEach(function(e){return e.removeAttribute("data-number")})}},onmove:function(evt){var el,x,y;el=evt.target;x=(parseFloat(el.dataset.x)||0)+evt.dx;y=(parseFloat(el.dataset.y)||0)+evt.dy;el.style.transform=`translate(${x}px, ${y}px) rotate(var(--rotation, 0))`;el.dataset.x=x;return el.dataset.y=y},onend:function(evt){var c,col,color_class,data,el,len1,m,num,number,r,ref1,row,snap,snapped;el=evt.target;snap=evt.modifiers[0];snapped=snap.inRange;if(snapped){el.classList.add("snapped");el.style.removeProperty("z-index");el.removeEventListener("click",tetramino_click_handler);el.querySelectorAll(".cell").forEach(function(c){return c.addEventListener("click",tetramino_color_click_handler)});data=get_tetramino_data(el);row=Math.floor(snap.target.index/data.col_array.length);col=snap.target.index%data.col_array.length;num=Math.random();ref1=get_tetramino_indices(el,row,col);for(m=0,len1=ref1.length;m<len1;m++){[r,c]=ref1[m];outline_board.rows[r].cells[c].setAttribute("data-number",num);el.setAttribute("data-number",num)}}else{number=el.getAttribute("data-number");outline_board.querySelectorAll(`[data-number='${number}']`).forEach(function(e){return e.removeAttribute("data-number")});color_class=el.querySelector(".cell").getAttribute("data-class");if(color_class){window.show_element(color_palette_dom.querySelector(`.${color_class}`))}el.remove()}game_grid.innerHTML="";return document.querySelectorAll(".snapped").forEach(function(el){var div,html,outline_board_rect,ox,oy,ratio,rotation_angle,shift_x,shift_y,snapped_grid,snapped_rect,source_cell_size,target_cell_size;snapped_grid=el.querySelector(".outline-grid");html=snapped_grid.innerHTML;rotation_angle=parseInt(el.getAttribute("data-rotation-angle"))||0;el.style.setProperty("--rotation","0deg");snapped_rect=el.getBoundingClientRect();el.style.setProperty("--rotation",`${rotation_angle}deg`);source_cell_size=parseFloat(getComputedStyle(outline_board.querySelector("td")).width);target_cell_size=parseFloat(getComputedStyle(game_board.querySelector("td")).width);ratio=target_cell_size/source_cell_size;outline_board_rect=outline_board.getBoundingClientRect();shift_x=(snapped_rect.left-outline_board_rect.left)*ratio;shift_y=(snapped_rect.top-outline_board_rect.top)*ratio;div=document.createElement("div");div.style.left=`${shift_x}px`;div.style.top=`${shift_y}px`;div.style.transform=`rotate(${rotation_angle}deg)`;[ox,oy]=getComputedStyle(el).transformOrigin.split(" ");div.style.transformOrigin=`${parseFloat(ox)*ratio}px ${parseFloat(oy)*ratio}px`;div.innerHTML=html;return game_grid.appendChild(div)})},modifiers:[interact.modifiers.snap({targets:function(){var m,results;results=[];for(i=m=0;m<9;i=++m){results.push(snap_targets(i))}return results}(),relativePoints:[{x:0,y:0}]})]}).styleCursor(false);interact("#outline table").dropzone({accept:".tetramino",overlap:.8});nodes.forEach(function(node){return node.addEventListener("click",function(){return node.classList.toggle("disabled")})});document.addEventListener("contextmenu",function(evt){var class_list;class_list=evt.target.classList;if(class_list.contains("tetramino")||class_list.contains("board-item")){return evt.preventDefault()}});error_field=document.getElementById("error-box");set_error=function(error){error_field.innerHTML=error;window.show_element(error_field);window.hide_element(response_field);return setTimeout(function(){return window.hide_element(error_field)},5e3)};response_field=document.getElementById("response-box");set_response=function(response){response_field.innerHTML=response;window.show_element(response_field);return window.hide_element(error_field)};document.getElementById("create-button").addEventListener("click",function(){var board,disabled_nodes,fixed_areas,k,outline,v;window.hide_element(error_field);outline=[];outline_dom.querySelectorAll("td").forEach(function(e){var number;number=e.getAttribute("data-number");if(number){return outline.push(number)}});if(outline.length!==N*M){set_error("Incomplete outline.");return}fixed_areas={};document.querySelectorAll(".snapped").forEach(function(e){var index;index=e.querySelector(".cell").getAttribute("data-index");if(index){return fixed_areas[e.getAttribute("data-number")]=index}});board=[];game_dom.querySelectorAll("td").forEach(function(e){var index;index=e.getAttribute("data-index");if(index){return board.push(index)}});if(board.length!==M*N){set_error("Incomplete board.");return}disabled_nodes=[];nodes.forEach(function(n){if(n.classList.contains("disabled")){return disabled_nodes.push(n.getAttribute("data-value"))}});if(disabled_nodes.length===(M-1)*(N-1)){set_error("No active nodes.");return}return send_request("/post-create/",{outline:outline.join(","),fixed_areas:function(){var results;results=[];for(k in fixed_areas){v=fixed_areas[k];results.push(`${k}:${v}`)}return results}().join(","),board:board.join(","),nodes:disabled_nodes.join(",")},"POST",function(data){if(data["error"]){set_error(data["error"])}if(data["url"]){return set_response(data["url"])}})})}).call(this);