// Generated by CoffeeScript 2.7.0
(function() {
  var M, N, active_nodes_dom, animate, animated, board, check, end_time, game_completed, get_cell, get_cells_from_indices, get_node_and_direction, get_source_cells, get_source_indices, get_target_cells, get_target_indices, hold_duration, hold_timer, in_animation, in_demo, is_rotate_node, is_sliding, make_move, max_date, min_date, moves, moves_made_num_dom, moves_num_dom, moves_sequence_dom, one_less_move_dom, puzzle_date_dom, restart_button, rotate, set_shareable_text, shareable_text_dom, slided_cells, start_time, table, today_date, undo, undo_button, validate, visit_time;

  visit_time = new Date();

  start_time = visit_time;

  end_time = start_time;

  board = document.getElementById('game-container');

  table = board.querySelector('table');

  N = table.rows.length;

  M = table.rows[0].cells.length;

  game_completed = false;

  in_animation = false;

  animated = false;

  in_demo = false;

  moves = [];

  moves_made_num_dom = document.getElementById('moves-made-num');

  undo_button = document.getElementById('undo-move');

  restart_button = document.getElementById('restart-game');

  moves_sequence_dom = document.getElementById('moves-sequence');

  one_less_move_dom = document.getElementById('one-less-move');

  moves_num_dom = document.getElementById('moves-num');

  active_nodes_dom = [...document.querySelectorAll('.node.active')];

  shareable_text_dom = document.getElementById('shareable-text');

  puzzle_date_dom = document.getElementById('puzzle-date');

  today_date = null;

  if (puzzle_date_dom) {
    min_date = puzzle_date_dom.getAttribute('min');
    max_date = puzzle_date_dom.getAttribute('max');
    today_date = puzzle_date_dom.value;
    puzzle_date_dom.addEventListener("change", function() {
      var value;
      value = this.value;
      if (value && /^\d{4}-\d{2}-\d{2}$/.test(value) && (min_date <= value && value <= max_date)) {
        return window.location.href = `/${value}/`;
      }
    });
  }

  hold_timer = null;

  hold_duration = 500;

  is_sliding = false;

  slided_cells = [];

  is_rotate_node = function(node) {
    return node.getAttribute('data-name') === 'rotate';
  };

  get_cells_from_indices = function(indices) {
    var cells, col, index, j, len, row;
    cells = [];
    for (j = 0, len = indices.length; j < len; j++) {
      index = indices[j];
      row = Math.floor(index / M);
      col = index % M;
      cells.push(document.getElementById(`cell-${row}-${col}`));
    }
    return cells;
  };

  get_source_indices = function(node, direct) {
    var arr;
    arr = node.getAttribute(`data-${direct ? 'source' : 'target'}`).split(',');
    return arr.map(function(item) {
      return parseInt(item);
    });
  };

  get_target_indices = function(node, direct) {
    var arr;
    arr = node.getAttribute(`data-${direct ? 'target' : 'source'}`).split(',');
    return arr.map(function(item) {
      return parseInt(item);
    });
  };

  get_source_cells = function(node, direct) {
    return get_cells_from_indices(get_source_indices(node, direct));
  };

  get_target_cells = function(node, direct) {
    return get_cells_from_indices(get_target_indices(node, direct));
  };

  rotate = function(node, direct) {
    var cell, classes, htmls, i, j, k, len, len1, ref, ref1, results, values;
    htmls = [];
    classes = [];
    values = [];
    ref = get_source_cells(node, direct);
    for (j = 0, len = ref.length; j < len; j++) {
      cell = ref[j];
      htmls.push(cell.innerHTML);
      classes.push(cell.className);
      values.push(cell.getAttribute('data-value'));
    }
    ref1 = get_target_cells(node, direct);
    results = [];
    for (i = k = 0, len1 = ref1.length; k < len1; i = ++k) {
      cell = ref1[i];
      cell.innerHTML = htmls[i];
      cell.className = classes[i];
      results.push(cell.setAttribute('data-value', values[i]));
    }
    return results;
  };

  check = function() {
    var col, col1, elem, elem1, index, index1, j, k, ref, ref1, ref2, row, row1, value, value1;
    for (index = j = 0, ref = N * M; (0 <= ref ? j < ref : j > ref); index = 0 <= ref ? ++j : --j) {
      row = Math.floor(index / M);
      col = index % M;
      elem = document.getElementById(`cell-${row}-${col}`);
      value = parseInt(elem.getAttribute('data-value'));
      if (outline[index] < 0 && value !== outline[index]) {
        return false;
      }
      for (index1 = k = ref1 = index + 1, ref2 = N * M; (ref1 <= ref2 ? k < ref2 : k > ref2); index1 = ref1 <= ref2 ? ++k : --k) {
        row1 = Math.floor(index1 / M);
        col1 = index1 % M;
        elem1 = document.getElementById(`cell-${row1}-${col1}`);
        value1 = parseInt(elem1.getAttribute('data-value'));
        if (!(value !== value1) !== !(outline[index] !== outline[index1])) {
          return false;
        }
      }
    }
    return true;
  };

  set_shareable_text = function() {
    var emoji, full_text, moves_made, moves_text, number, rows, text;
    moves_made = moves.length;
    emoji = null;
    text = null;
    full_text = null;
    rows = null;
    number = `#${game_index}`;
    if (today_date) {
      number += ` (${today_date})`;
    }
    if (check()) {
      if (moves_made === moves_min_num) {
        emoji = 'ðŸ§ âœ¨';
        text = 'Perfect Solve';
      } else if (moves_made - moves_min_num <= 3) {
        emoji = 'ðŸ¤';
        text = 'So close!';
      } else {
        emoji = 'ðŸ§©';
        text = 'Solved';
      }
      full_text = `Rotatly ${number} ${emoji}\n${text}\nMoves: ${moves_made}/${moves_min_num}\n${canonical_url}`;
    } else {
      moves_text = '';
      if (moves_made === 0) {
        emoji = 'ðŸ˜´';
        moves_text = "Didn't try today\nIt's never too late to start!";
      } else if (moves_made < moves_min_num * 2) {
        emoji = 'â³';
        moves_text = `Rotatingâ€¦\nMoves: ${moves_made}`;
      } else {
        emoji = 'ðŸ˜¤';
        moves_text = "This one got me\nWant to take a shot?";
      }
      full_text = `Rotatly ${number} ${emoji}\n${moves_text}\n${canonical_url}`;
    }
    return shareable_text_dom.value = full_text;
  };

  set_shareable_text();

  animate = function(node, direct, undo = false, demo = false, callback = null) {
    var cell, cells, classes, finished, i, idx, j, len, node_name, results, transition_callback;
    if (in_animation) {
      return;
    }
    in_animation = true;
    animated = true;
    finished = 0;
    cells = get_target_cells(node, true);
    node_name = node.getAttribute('data-name');
    if (is_rotate_node(node)) {
      classes = [(direct ? 'move-right' : 'move-down'), (direct ? 'move-down' : 'move-left'), (direct ? 'move-left' : 'move-up'), (direct ? 'move-up' : 'move-right')];
    } else if (node_name === 'horizontal') {
      classes = (function() {
        var j, ref, results;
        results = [];
        for (i = j = 0, ref = cells.length; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
          results.push(direct ? 'move-right' : 'move-left');
        }
        return results;
      })();
    } else if (node_name === 'vertical') {
      classes = (function() {
        var j, ref, results;
        results = [];
        for (i = j = 0, ref = cells.length; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
          results.push(direct ? 'move-down' : 'move-up');
        }
        return results;
      })();
    }
    transition_callback = function(e) {
      var block, c, idx, j, k, len, len1, number_of_moves, solved, symbol;
      if (e.propertyName === 'transform') {
        finished += 1;
        if (finished === cells.length) {
          for (idx = j = 0, len = cells.length; j < len; idx = ++j) {
            c = cells[idx];
            c.classList.remove('animate');
            c.classList.add('non-animate');
            c.removeEventListener('transitionend', transition_callback);
            c.classList.remove(classes[idx]);
          }
          for (k = 0, len1 = cells.length; k < len1; k++) {
            c = cells[k];
            c.offsetHeight;
          }
          rotate(node, direct);
          if (!undo) {
            symbol = node.getAttribute(`data${direct ? '' : '-reverse'}-symbol`);
            moves.push(`${node.getAttribute('data-index')}${symbol}`);
            moves_sequence_dom.innerHTML = moves.length ? moves.join(' ') : 'no moves';
            if (!demo) {
              undo_button.removeAttribute('disabled');
              restart_button.removeAttribute('disabled');
            }
          }
          number_of_moves = moves.length;
          set_shareable_text();
          if (number_of_moves === 1 && !undo) {
            start_time = new Date();
          }
          moves_made_num_dom.innerHTML = number_of_moves;
          solved = check();
          if (!demo && (number_of_moves >= moves_max_num || solved)) {
            end_time = new Date();
            game_completed = true;
            active_nodes_dom.forEach(function(node) {
              return window.hide_element(node);
            });
            window.hide_element(undo_button);
            if (solved) {
              one_less_move_dom.innerHTML = number_of_moves - 1;
              moves_num_dom.innerHTML = number_of_moves;
              block = document.getElementById(`${number_of_moves > moves_min_num ? 'non-' : ''}min-text`);
            } else {
              block = document.getElementById("non-solve-text");
            }
            //window.show_element(block)
            window.send_request(track_url, {
              game_index: game_index,
              init_time: (start_time - visit_time) / 1000,
              game_time: (end_time - start_time) / 1000,
              moves: moves.join(''),
              length: number_of_moves
            });
          }
          in_animation = false;
          if (callback) {
            return callback();
          }
        }
      }
    };
    results = [];
    for (idx = j = 0, len = cells.length; j < len; idx = ++j) {
      cell = cells[idx];
      cell.classList.remove('non-animate');
      cell.classList.add('animate');
      cell.addEventListener('transitionend', transition_callback);
      results.push(cell.classList.add(classes[idx]));
    }
    return results;
  };

  undo = function(callback) {
    var direction, elem, index, node;
    if (moves.length > 0) {
      elem = moves.pop();
      moves_sequence_dom.innerHTML = moves.length ? moves.join(' ') : 'no moves';
      index = elem.slice(0, -1);
      direction = elem.slice(-1);
      node = active_nodes_dom.filter(function(n) {
        if (n.getAttribute('data-index') === `${index}`) {
          if (n.getAttribute('data-symbol') === direction || n.getAttribute('data-reverse-symbol') === direction) {
            return true;
          }
        }
      })[0];
      if (node) {
        return animate(node, direction !== node.getAttribute('data-symbol'), true, false, callback ? callback : undo);
      }
    }
  };

  make_move = function() {
    return setTimeout(function() {
      var direction, elem, index, node;
      if (pre_moves.length > 0) {
        undo_button.setAttribute('disabled', true);
        restart_button.setAttribute('disabled', true);
        elem = pre_moves.shift();
        index = elem[0];
        direction = elem[1];
        node = active_nodes_dom.filter(function(n) {
          if (n.getAttribute('data-index') === `${index}`) {
            if (n.getAttribute('data-symbol') === direction && n.getAttribute('data-allow-direct') === 'true') {
              return true;
            }
            if (n.getAttribute('data-reverse-symbol') === direction && n.getAttribute('data-allow-reverse') === 'true') {
              return true;
            }
          }
        })[0];
        if (node) {
          return animate(node, direction === node.getAttribute('data-symbol'), false, true, make_move);
        } else {
          in_demo = false;
          undo_button.removeAttribute('disabled');
          return restart_button.removeAttribute('disabled');
        }
      } else {
        in_demo = false;
        undo_button.removeAttribute('disabled');
        return restart_button.removeAttribute('disabled');
      }
    }, 700);
  };

  if (pre_moves.length > 0) {
    in_demo = true;
    make_move();
  }

  active_nodes_dom.filter(function(n) {
    return is_rotate_node(n);
  }).forEach(function(node) {
    node.addEventListener('click', function() {
      if (!animated) {
        return animate(this, true);
      }
    });
    node.addEventListener('pointerdown', function() {
      var n;
      n = this;
      if (!in_animation) {
        animated = false;
        return hold_timer = setTimeout(function() {
          clearTimeout(hold_timer);
          hold_timer = null;
          if (!animated) {
            return animate(n, false);
          }
        }, hold_duration);
      }
    });
    return node.addEventListener('pointerup pointerleave pointercancel', function() {
      if (hold_timer) {
        clearTimeout(hold_timer);
        return hold_timer = null;
      }
    });
  });

  active_nodes_dom.filter(function(n) {
    return !is_rotate_node(n);
  }).forEach(function(node) {
    return node.addEventListener('click', function() {
      return animate(this, node.getAttribute('data-direction') === node.getAttribute('data-symbol'));
    });
  });

  document.addEventListener('contextmenu', function(evt) {
    var node;
    node = evt.target;
    if (board.contains(node)) {
      evt.preventDefault();
      if (!animated && is_rotate_node(node) && active_nodes_dom.includes(node)) {
        return animate(node, false);
      }
    }
  });

  undo_button.addEventListener('click', function() {
    undo_button.setAttribute('disabled', true);
    restart_button.setAttribute('disabled', true);
    return undo(function() {
      if (moves.length > 0) {
        undo_button.removeAttribute('disabled');
        return restart_button.removeAttribute('disabled');
      }
    });
  });

  restart_button.addEventListener('click', function() {
    [...document.getElementById("non-solve-text").parentElement.children].forEach(function(node) {
      return window.hide_element(node);
    });
    active_nodes_dom.forEach(function(node) {
      return window.show_element(node);
    });
    undo_button.setAttribute('disabled', true);
    window.show_element(undo_button);
    restart_button.setAttribute('disabled', true);
    game_completed = false;
    return undo();
  });

  get_cell = function(target) {
    if (!table.contains(target)) {
      return null;
    }
    if (target.tagName !== 'TD') {
      target = target.closest('td');
    }
    return target;
  };

  validate = function() {
    var current, current_col, current_row, i, j, n, next, next_col, next_row, ref;
    n = slided_cells.length;
    if (n < 2) {
      return true;
    }
    for (i = j = 0, ref = n - 1; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
      current = slided_cells[i];
      next = slided_cells[i + 1];
      current_row = parseInt(current.getAttribute('data-row'));
      current_col = parseInt(current.getAttribute('data-col'));
      next_row = parseInt(next.getAttribute('data-row'));
      next_col = parseInt(next.getAttribute('data-col'));
      if (Math.abs(current_row - next_row) + Math.abs(current_col - next_col) !== 1) {
        return false;
      }
    }
    return true;
  };

  get_node_and_direction = function() {
    var cell, col, indices, indices_str, j, k, len, len1, node, node_indices, row;
    if (slided_cells.length !== 3) {
      return null;
    }
    indices = [];
    for (j = 0, len = slided_cells.length; j < len; j++) {
      cell = slided_cells[j];
      row = parseInt(cell.getAttribute('data-row'));
      col = parseInt(cell.getAttribute('data-col'));
      indices.push(row * M + col);
    }
    indices_str = indices.join(',');
    for (k = 0, len1 = active_nodes_dom.length; k < len1; k++) {
      node = active_nodes_dom[k];
      node_indices = get_target_indices(node, true);
      node_indices = node_indices.concat(node_indices);
      if (node_indices.join(',').includes(indices_str)) {
        return [node, true];
      }
      node_indices.reverse();
      if (node_indices.join(',').includes(indices_str)) {
        return [node, false];
      }
    }
  };

  table.addEventListener("pointerdown", function(e) {
    if (!game_completed && !in_demo) {
      is_sliding = true;
      return slided_cells = [get_cell(e.target)];
    }
  });

  table.addEventListener("pointermove", function(e) {
    var cell, direct, node, node_and_direction;
    if (is_sliding) {
      cell = get_cell(document.elementFromPoint(e.clientX, e.clientY));
      if (cell) {
        if (slided_cells.indexOf(cell) >= 0) {
          slided_cells = slided_cells.filter(function(c) {
            return c !== cell;
          });
          return slided_cells.push(cell);
        } else {
          slided_cells.push(cell);
          slided_cells = slided_cells.slice(-3);
          if (validate()) {
            node_and_direction = get_node_and_direction();
            if (node_and_direction !== null) {
              if (node_and_direction) {
                node = node_and_direction[0];
                direct = node_and_direction[1];
                if (node && node.getAttribute(`data-allow-${direct ? 'direct' : 'reverse'}`) === 'true') {
                  animate(node, direct);
                }
              }
              is_sliding = false;
              return slided_cells = [];
            }
          } else {
            is_sliding = false;
            return slided_cells = [];
          }
        }
      }
    }
  });

  table.addEventListener("pointerup pointerleave pointercancel", function() {
    is_sliding = false;
    return slided_cells = [];
  });

  document.addEventListener('keydown', function(e) {
    if (e.metaKey || e.ctrlKey) {
      if (e.key === 'x' || e.key === 'X') {
        if (!restart_button.getAttribute('disabled')) {
          restart_button.click();
        }
      }
      if (e.key === 'z' || e.key === 'Z') {
        if (!undo_button.getAttribute('disabled')) {
          return undo_button.click();
        }
      }
    }
  });

  document.getElementById('copy-result').addEventListener('click', function() {
    var share_text;
    share_text = shareable_text_dom.value;
    navigator.clipboard.writeText(share_text).then(function() {
      var toast;
      toast = document.getElementById('copy-toast');
      window.show_element(toast);
      return setTimeout(function() {
        return window.hide_element(toast);
      }, 2000);
    });
    return window.send_request(track_url, {
      game_index: game_index,
      init_time: (start_time - visit_time) / 1000,
      game_time: (end_time - start_time) / 1000,
      moves: moves.join(''),
      length: moves.length,
      copied: true
    });
  });

  document.getElementById('share-icon').addEventListener('click', function() {
    var container;
    container = document.getElementById('share-container');
    container.parentNode.insertBefore(container, document.getElementById('target-outline-container'));
    return container.insertBefore(shareable_text_dom, document.getElementById('copy-result'));
  });

}).call(this);

//# sourceMappingURL=game.js.map
