{% extends './../base.html' %}
{% load static %}
{% block css %}
    <link href="{% static "css/game.css" %}?v=49" rel="stylesheet">
{% endblock %}
{% block content %}
    <div class="game-screen" style="--board-size: {{ size }};">
        <header class="game-header game-header--mobile">
            <div class="mobile-nav-left">
                <button
                    class="icon-button"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#instructions-modal"
                    aria-label="Instructions"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                        focusable="false"
                    >
                        <path
                            d="M6.66675 6.66666C6.66675 6.00362 6.97404 5.36773 7.52102 4.89889C8.068 4.43005 8.80987 4.16666 9.58341 4.16666H10.4167C11.1903 4.16666 11.9322 4.43005 12.4791 4.89889C13.0261 5.36773 13.3334 6.00362 13.3334 6.66666C13.3641 7.2077 13.2182 7.74407 12.9176 8.19497C12.617 8.64587 12.178 8.98689 11.6667 9.16666C11.1555 9.40635 10.7165 9.86104 10.4159 10.4622C10.1153 11.0634 9.9694 11.7786 10.0001 12.5M10.0001 15.8333V15.8417"
                            stroke="#62351D"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </button>
                <a
                    href="mailto:support@rotatly.com"
                    target="_blank"
                    rel="noopener"
                    class="icon-button"
                    aria-label="Contact Us"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                        focusable="false"
                    >
                        <path
                            d="M2.5 5.83329C2.5 5.39127 2.67559 4.96734 2.98816 4.65478C3.30072 4.34222 3.72464 4.16663 4.16667 4.16663H15.8333C16.2754 4.16663 16.6993 4.34222 17.0118 4.65478C17.3244 4.96734 17.5 5.39127 17.5 5.83329M2.5 5.83329V14.1666C2.5 14.6087 2.67559 15.0326 2.98816 15.3451C3.30072 15.6577 3.72464 15.8333 4.16667 15.8333H15.8333C16.2754 15.8333 16.6993 15.6577 17.0118 15.3451C17.3244 15.0326 17.5 14.6087 17.5 14.1666V5.83329M2.5 5.83329L10 10.8333L17.5 5.83329"
                            stroke="#62351D"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </a>
                <button class="icon-button" type="button" id="share-icon" aria-label="Share">
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                        focusable="false"
                    >
                        <path
                            d="M7.25 8.91666L12.75 6.08332M7.25 11.0833L12.75 13.9167M2.5 10C2.5 10.663 2.76339 11.2989 3.23223 11.7678C3.70107 12.2366 4.33696 12.5 5 12.5C5.66304 12.5 6.29893 12.2366 6.76777 11.7678C7.23661 11.2989 7.5 10.663 7.5 10C7.5 9.33696 7.23661 8.70107 6.76777 8.23223C6.29893 7.76339 5.66304 7.5 5 7.5C4.33696 7.5 3.70107 7.76339 3.23223 8.23223C2.76339 8.70107 2.5 9.33696 2.5 10ZM12.5 5C12.5 5.66304 12.7634 6.29893 13.2322 6.76777C13.7011 7.23661 14.337 7.5 15 7.5C15.663 7.5 16.2989 7.23661 16.7678 6.76777C17.2366 6.29893 17.5 5.66304 17.5 5C17.5 4.33696 17.2366 3.70107 16.7678 3.23223C16.2989 2.76339 15.663 2.5 15 2.5C14.337 2.5 13.7011 2.76339 13.2322 3.23223C12.7634 3.70107 12.5 4.33696 12.5 5ZM12.5 15C12.5 15.663 12.7634 16.2989 13.2322 16.7678C13.7011 17.2366 14.337 17.5 15 17.5C15.663 17.5 16.2989 17.2366 16.7678 16.7678C17.2366 16.2989 17.5 15.663 17.5 15C17.5 14.337 17.2366 13.7011 16.7678 13.2322C16.2989 12.7634 15.663 12.5 15 12.5C14.337 12.5 13.7011 12.7634 13.2322 13.2322C12.7634 13.7011 12.5 14.337 12.5 15Z"
                            stroke="#62351D"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </button>
                <a
                    href="https://github.com/proy87/rotatly"
                    target="_blank"
                    rel="noopener"
                    class="icon-button"
                    aria-label="View on GitHub"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                        focusable="false"
                    >
                        <path
                            d="M7.5 15.8333C3.91667 17 3.91667 13.75 2.5 13.3333M12.5 17.5V14.5833C12.5 13.75 12.5833 13.4166 12.0833 12.9166C14.4167 12.6666 16.6667 11.75 16.6667 7.91663C16.6657 6.92076 16.2771 5.96438 15.5833 5.24996C15.9087 4.38493 15.8788 3.42632 15.5 2.58329C15.5 2.58329 14.5833 2.33329 12.5833 3.66663C10.8894 3.22545 9.11064 3.22545 7.41667 3.66663C5.41667 2.33329 4.5 2.58329 4.5 2.58329C4.12123 3.42632 4.09128 4.38493 4.41667 5.24996C3.72288 5.96438 3.33435 6.92076 3.33333 7.91663C3.33333 11.75 5.58333 12.6666 7.91667 12.9166C7.41667 13.4166 7.41667 13.9166 7.5 14.5833V17.5"
                            stroke="#62351D"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </a>
            </div>
            <button class="icon-button" type="button" aria-label="Menu" data-action="open-menu">
                <i class="fa-solid fa-bars" aria-hidden="true"></i>
            </button>
        </header>

        <div class="mobile-menu-overlay" id="mobile-menu-overlay" hidden>
            <div class="mobile-menu" role="dialog" aria-modal="true">
                <header class="mobile-menu-header">
                    <span class="mobile-menu-title">Rotatly</span>
                    <button class="icon-button" type="button" aria-label="Close menu" data-action="close-menu">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    </button>
                </header>
                <div class="mobile-menu-body">
                    <span class="mobile-menu-username">{% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}</span>
                    <nav class="mobile-menu-links" aria-label="Mobile navigation">
                        <a class="mobile-menu-button" href="{% url 'profile' %}">
                            <svg
                                class="mobile-menu-icon"
                                width="20"
                                height="20"
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                focusable="false"
                            >
                                <path
                                    d="M5 17.5V15.8333C5 14.9493 5.35119 14.1014 5.97631 13.4763C6.60143 12.8512 7.44928 12.5 8.33333 12.5H11.6667C12.5507 12.5 13.3986 12.8512 14.0237 13.4763C14.6488 14.1014 15 14.9493 15 15.8333V17.5M6.66667 5.83333C6.66667 6.71739 7.01786 7.56523 7.64298 8.19036C8.2681 8.81548 9.11594 9.16667 10 9.16667C10.8841 9.16667 11.7319 8.81548 12.357 8.19036C12.9821 7.56523 13.3333 6.71739 13.3333 5.83333C13.3333 4.94928 12.9821 4.10143 12.357 3.47631C11.7319 2.85119 10.8841 2.5 10 2.5C9.11594 2.5 8.2681 2.85119 7.64298 3.47631C7.01786 4.10143 6.66667 4.94928 6.66667 5.83333Z"
                                    stroke="#62351D"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Profile</span>
                        </a>
                        <a class="mobile-menu-button" href="{% url 'leaderboard' %}">
                            <svg
                                class="mobile-menu-icon"
                                width="20"
                                height="20"
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                focusable="false"
                            >
                                <g clip-path="url(#clip0_leaderboard_mobile)">
                                    <path d="M10.0002 13.3333C5.20026 13.3333 4.34994 8.54961 4.19931 4.75538C4.1574 3.69997 4.13645 3.17226 4.53289 2.68402C4.92932 2.19577 5.40379 2.11572 6.35273 1.95561C7.28945 1.79756 8.51392 1.66666 10.0002 1.66666C11.4865 1.66666 12.711 1.79756 13.6477 1.95561C14.5966 2.11572 15.0711 2.19577 15.4675 2.68402C15.864 3.17226 15.843 3.69997 15.8011 4.75538C15.6505 8.54961 14.8002 13.3333 10.0002 13.3333Z" stroke="#62351D" stroke-width="1.5"/>
                                    <path d="M15.8333 4.16666L16.6238 4.43016C17.4488 4.70518 17.8613 4.84269 18.0973 5.17006C18.3332 5.49743 18.3332 5.93226 18.3332 6.80194L18.3332 6.86238C18.3332 7.57966 18.3332 7.93831 18.1605 8.23174C17.9879 8.52516 17.6743 8.69934 17.0473 9.04769L14.5833 10.4167" stroke="#62351D" stroke-width="1.5"/>
                                    <path d="M4.1667 4.16666L3.37618 4.43016C2.55113 4.70518 2.13861 4.84269 1.90266 5.17006C1.66671 5.49743 1.66673 5.93226 1.66675 6.80194L1.66675 6.86238C1.66677 7.57966 1.66678 7.93831 1.83944 8.23174C2.01209 8.52516 2.32561 8.69934 2.95262 9.04769L5.4167 10.4167" stroke="#62351D" stroke-width="1.5"/>
                                    <path d="M10 14.1667V15.8333" stroke="#62351D" stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M12.9166 18.3333H7.08325L7.36594 16.9199C7.44384 16.5304 7.78585 16.25 8.18309 16.25H11.8167C12.214 16.25 12.556 16.5304 12.6339 16.9199L12.9166 18.3333Z" stroke="#62351D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M15 18.3333H5" stroke="#62351D" stroke-width="1.5" stroke-linecap="round"/>
                                </g>
                                <defs>
                                    <clipPath id="clip0_leaderboard_mobile">
                                        <rect width="20" height="20" fill="white"/>
                                    </clipPath>
                                </defs>
                            </svg>
                            <span>Leaderboard</span>
                        </a>
                        <a class="mobile-menu-button" href="{% url 'create' %}">
                            <svg
                                class="mobile-menu-icon"
                                width="20"
                                height="20"
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                focusable="false"
                            >
                                <path
                                    d="M11.6666 14.1667H16.6666M14.1666 11.6667V16.6667M3.33325 4.16668C3.33325 3.94566 3.42105 3.7337 3.57733 3.57742C3.73361 3.42114 3.94557 3.33334 4.16659 3.33334H7.49992C7.72093 3.33334 7.93289 3.42114 8.08917 3.57742C8.24545 3.7337 8.33325 3.94566 8.33325 4.16668V7.50001C8.33325 7.72102 8.24545 7.93299 8.08917 8.08927C7.93289 8.24555 7.72093 8.33334 7.49992 8.33334H4.16659C3.94557 8.33334 3.73361 8.24555 3.57733 8.08927C3.42105 7.93299 3.33325 7.72102 3.33325 7.50001V4.16668ZM11.6666 4.16668C11.6666 3.94566 11.7544 3.7337 11.9107 3.57742C12.0669 3.42114 12.2789 3.33334 12.4999 3.33334H15.8333C16.0543 3.33334 16.2662 3.42114 16.4225 3.57742C16.5788 3.7337 16.6666 3.94566 16.6666 4.16668V7.50001C16.6666 7.72102 16.5788 7.93299 16.4225 8.08927C16.2662 8.24555 16.0543 8.33334 15.8333 8.33334H12.4999C12.2789 8.33334 12.0669 8.24555 11.9107 8.08927C11.7544 7.93299 11.6666 7.72102 11.6666 7.50001V4.16668ZM3.33325 12.5C3.33325 12.279 3.42105 12.067 3.57733 11.9108C3.73361 11.7545 3.94557 11.6667 4.16659 11.6667H7.49992C7.72093 11.6667 7.93289 11.7545 8.08917 11.9108C8.24545 12.067 8.33325 12.279 8.33325 12.5V15.8333C8.33325 16.0544 8.24545 16.2663 8.08917 16.4226C7.93289 16.5789 7.72093 16.6667 7.49992 16.6667H4.16659C3.94557 16.6667 3.73361 16.5789 3.57733 16.4226C3.42105 16.2663 3.33325 16.0544 3.33325 15.8333V12.5Z"
                                    stroke="#62351D"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Create Puzzle</span>
                        </a>
                    </nav>
                    <button class="mobile-menu-button mobile-menu-button--logout" type="button" data-logout>
                        <svg
                            class="mobile-menu-icon"
                            width="20"
                            height="20"
                            viewBox="0 0 20 20"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            aria-hidden="true"
                            focusable="false"
                        >
                            <path
                                d="M11.6667 6.66668V5.00001C11.6667 4.55798 11.4911 4.13406 11.1785 3.8215C10.866 3.50894 10.442 3.33334 10 3.33334H4.16667C3.72464 3.33334 3.30072 3.50894 2.98816 3.8215C2.67559 4.13406 2.5 4.55798 2.5 5.00001V15C2.5 15.442 2.67559 15.866 2.98816 16.1785C3.30072 16.4911 3.72464 16.6667 4.16667 16.6667H10C10.442 16.6667 10.866 16.4911 11.1785 16.1785C11.4911 15.866 11.6667 15.442 11.6667 15V13.3333M5.83333 10H17.5M17.5 10L15 7.50001M17.5 10L15 12.5"
                                stroke="white"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <main class="game-main">
            <section class="game-hero">
                <div class="game-hero-left">
                    <h1 class="puzzle-title">{% block title %}{% endblock %}</h1>
                    {% block calendar %}{% endblock %}

                    <div class="moves-hint" aria-label="Minimum moves">
                        <span class="moves-hint-text">Minimum number of moves to solve:</span>
                        <span class="moves-hint-value">{{ game.moves_min_num }}</span>
                    </div>
                </div>

                <div id="target-outline-container" class="target-outline">
                    <span class="target-label">Target outline</span>
                    <div class="target-preview">
                        <div class="outline-container">
                            {% include './includes/board.html' with board=target_preview is_outline=True skip_grid=False %}
                        </div>
                    </div>
                </div>
            </section>

            <section class="game-board-row">
                <div id="game-board-container" class="game-board-container">
                    <div id="game-container" class="game-board">
                        <div class="game-grid">
                            {% include './includes/board.html' %}
                        </div>
                        <div class="game-nodes">
                            {% include './includes/nodes.html' %}
                        </div>
                    </div>
                    <div id="win-overlay" class="win-overlay" style="display: none;" data-display="flex">
                        <span id="win-text" class="win-text"></span>
                    </div>
                </div>
            </section>

            <section class="game-controls">
                <button id="undo-move" class="control-button control-button--undo" disabled>
                    <i class="fa-solid fa-rotate-left control-icon" aria-hidden="true"></i>
                    <span>Undo</span>
                </button>
                <button id="restart-game" class="control-button control-button--restart" disabled>
                    <i class="fa-solid fa-rotate-right control-icon" aria-hidden="true"></i>
                    <span>Restart</span>
                </button>
            </section>

            <section class="game-stats">
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Rotatly #{{ game.index }}</h2>
                        {% if current_date %}<span class="stats-date">{{ current_date }}</span>{% endif %}
                    </div>
                    <div id="stats-initial" class="stats-body">
                        <p class="stats-status">Didn't try today</p>
                        <p class="stats-status">It's never too late to start!</p>
                    </div>
                    <div id="stats-playing" class="stats-body" style="display: none;">
                        <p class="stats-status">Rotating...</p>
                        <p class="stats-moves">
                            Moves made: <strong id="moves-made-num">0</strong>
                        </p>
                    </div>
                    <div id="share-container" class="share-card">
                        <button id="copy-result" class="stats-share-button" type="button">
                            <svg
                                class="stats-share-icon"
                                width="20"
                                height="20"
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                focusable="false"
                            >
                                <path
                                    d="M7.25 8.91666L12.75 6.08332M7.25 11.0833L12.75 13.9167M2.5 10C2.5 10.663 2.76339 11.2989 3.23223 11.7678C3.70107 12.2366 4.33696 12.5 5 12.5C5.66304 12.5 6.29893 12.2366 6.76777 11.7678C7.23661 11.2989 7.5 10.663 7.5 10C7.5 9.33696 7.23661 8.70107 6.76777 8.23223C6.29893 7.76339 5.66304 7.5 5 7.5C4.33696 7.5 3.70107 7.76339 3.23223 8.23223C2.76339 8.70107 2.5 9.33696 2.5 10ZM12.5 5C12.5 5.66304 12.7634 6.29893 13.2322 6.76777C13.7011 7.23661 14.337 7.5 15 7.5C15.663 7.5 16.2989 7.23661 16.7678 6.76777C17.2366 6.29893 17.5 5.66304 17.5 5C17.5 4.33696 17.2366 3.70107 16.7678 3.23223C16.2989 2.76339 15.663 2.5 15 2.5C14.337 2.5 13.7011 2.76339 13.2322 3.23223C12.7634 3.70107 12.5 4.33696 12.5 5ZM12.5 15C12.5 15.663 12.7634 16.2989 13.2322 16.7678C13.7011 17.2366 14.337 17.5 15 17.5C15.663 17.5 16.2989 17.2366 16.7678 16.7678C17.2366 16.2989 17.5 15.663 17.5 15C17.5 14.337 17.2366 13.7011 16.7678 13.2322C16.2989 12.7634 15.663 12.5 15 12.5C14.337 12.5 13.7011 12.7634 13.2322 13.2322C12.7634 13.7011 12.5 14.337 12.5 15Z"
                                    stroke="#62351D"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                            <span>Share result</span>
                        </button>
                        <div id="copy-toast" class="copy-toast" style="display: none;">
                            Copied! Share anywhere.
                        </div>
                        <textarea id="shareable-text" rows="4" aria-label="Shareable text" style="display: none;"></textarea>
                    </div>
                    <span id="moves-sequence" style="display: none;">no moves</span>
                </div>
                {% block prev_next_navigation %}{% endblock %}
            </section>
        </main>

    </div>
{% endblock %}
{% block modal %}
    <div class="modal fade" id="instructions-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fa fa-circle-question me-2"></i>How to Play
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                <p>Make the correct outline using the fewest number of rotations.</p>
                <p>Rotate the cells until you get the correct outline.</p>
                <p>An outline consists of blocks that are separated by a black border.</p>
                <p>Letters/colors within the same block should be the same.</p>
                <p>If the block in the target outline is colored, that exact color should be in that block.</p>
                <div class="instructions-controls">
                    <ul>
                        <li><i class="fa fa-arrow-rotate-right rotate-icon"></i> Click a blue node to rotate clockwise.</li>
                        <li>
                            <i class="fa fa-arrow-rotate-left rotate-icon"></i> Press and hold, or right-click a blue node,
                                to rotate counterclockwise.
                        </li>
                        <li>
                            <i class="fa fa-arrows-alt rotate-icon"></i> Slide across cells (to determine direction, you
                            need to slide across three cells).
                        </li>
                    </ul>
                </div>
                <hr>
                <div>
                    Have suggestions or feedback about Rotatly?<br>
                    We’d love to hear from you: <a href="mailto:support@rotatly.com">support@rotatly.com</a>
                </div>
            </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        let game_index = {{ game_index_json|safe }};
        let moves_max_num = {{ moves_max_num }};
        let moves_min_num = {{ game.moves_min_num }};
        let outline = {{ outline_dumped|safe }};
        let cw_symbol = '{{ cw_symbol }}';
        let ccw_symbol = '{{ ccw_symbol }}';

        let pre_moves = {{ pre_moves_dumped|safe }};
        let canonical_url = '{{ canonical_url }}';

        let track_url = '{% url "track" %}';
        let puzzle_type = '{{ puzzle_type }}';
    </script>
    {% if False %}
    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- gif.js -->
    <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
    <script>
        $(function () {
            function animate($node, cw, step) {
                let row = $node.data('row');
                let col = $node.data('col');
                let $tl = $(`#cell-${row}-${col}`);
                let $tr = $(`#cell-${row}-${col + 1}`);
                let $br = $(`#cell-${row + 1}-${col + 1}`);
                let $bl = $(`#cell-${row + 1}-${col}`);
                $tl.css('transform', (cw ? 'translateX' : 'translateY') + `(${step}px)`)
                $tr.css('transform', (cw ? 'translateY' : 'translateX') + (cw ? `(${step}px)` : `(-${step}px)`))
                $br.css('transform', (cw ? 'translateX' : 'translateY') + `(-${step}px)`)
                $bl.css('transform', (cw ? 'translateY' : 'translateX') + (cw ? `(-${step}px)` : `(${step}px)`))
            }

            document.getElementById("start").addEventListener("click", async () => {
                const target = document.getElementById("board");
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    workerScript: '{% static "js/gif.worker.js" %}'
                });
//dict(square=((2, 3, 3, 4), (4, 4, 3, 4), (2, 1, 1, 3), (1, 2, 2, 1)), min=9, index=10, disabled_nodes=[5, 9]),

                let steps = [[1, 'CW'], [6, 'CCW'], [2, 'CCW'], [1, 'CW'], [8, 'CW'], [7, 'CCW'], [6, 'CCW'], [4, 'CW'], [8, 'CCW']];

                let canvas = await html2canvas(target);
                gif.addFrame(canvas, {delay: 1000});
                for (let i = 0; i < steps.length; i++) {
                    let row = Math.floor((steps[i][0] - 1) / 3);
                    let col = (steps[i][0] - 1) % 3;
                    let $node = $('[data-row=' + row + '][data-col=' + col + ']').addClass('highlight').text(steps[i][1] === 'CW' ? '↻' : '↺');
                    for (let j = 7; j <= cell_width; j += 7) {
                        animate($node, steps[i][1] === 'CW', j)

                        let d;
                        if (i === steps.length - 1) {
                            d = (j === cell_width) ? 3000 : 500 / 11;
                        } else {
                            d = (j === cell_width) ? 1000 : 500 / 11;
                        }

                        if (j === cell_width) {
                            $node.removeClass('highlight').text($node.data('node'))
                            let $tl = $(`#cell-${row}-${col}`).css('transform', 'none');
                            let $tr = $(`#cell-${row}-${col + 1}`).css('transform', 'none');
                            let $br = $(`#cell-${row + 1}-${col + 1}`).css('transform', 'none');
                            let $bl = $(`#cell-${row + 1}-${col}`).css('transform', 'none');
                            $.rotate(row, col, steps[i][1] === 'CW')
                        }
                        const canvas = await html2canvas(target);
                        gif.addFrame(canvas, {delay: d});
                    }

                }

                gif.on("finished", blob => {
                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(blob);
                    document.body.appendChild(img);
                });

                gif.render();
            });
        })
    </script>
{% endif %}
{% block additional_js %}{% endblock %}
<script src="{% static 'js/game-ui.js' %}"></script>
<script src="{% static 'js/core.min.js' %}"></script>
<script src="{% static 'js/game.js' %}"></script>
{% endblock %}

