{% extends './../base.html' %}
{% load static %}
{% block css %}
    <link href="{% static "css/game.css" %}?v=28" rel="stylesheet">
{% endblock %}
{% block content %}
    <div class="game-screen" style="--board-size: {{ size }};">
        <header class="game-header game-header--desktop">
            <div class="game-header-inner">
                <a class="header-brand" href="{% url 'daily' %}" aria-label="Rotatly home">
                    <svg
                        class="header-logo"
                        width="100%"
                        height="100%"
                        viewBox="0 0 60 60"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                        focusable="false"
                    >
                        <rect
                            x="0.5"
                            y="0.5"
                            width="14"
                            height="59"
                            rx="3.5"
                            fill="#90634B"
                            stroke="#FFFBEB"
                        />
                        <mask id="rotatly-logo-mask-1" fill="white">
                            <path d="M26 15C28.2091 15 30 16.7909 30 19V43C30 44.1046 30.8954 45 32 45H41C43.2091 45 45 46.7909 45 49V56C45 58.2091 43.2091 60 41 60H19C18.9309 60 18.8622 59.9986 18.7939 59.9951C16.6806 59.8879 15 58.14 15 56V19C15 16.7909 16.7909 15 19 15H26Z" />
                        </mask>
                        <path
                            d="M26 15C28.2091 15 30 16.7909 30 19V43C30 44.1046 30.8954 45 32 45H41C43.2091 45 45 46.7909 45 49V56C45 58.2091 43.2091 60 41 60H19C18.9309 60 18.8622 59.9986 18.7939 59.9951C16.6806 59.8879 15 58.14 15 56V19C15 16.7909 16.7909 15 19 15H26Z"
                            fill="#90634B"
                        />
                        <path
                            d="M30 19H31V19H30ZM45 49H46V49H45ZM41 60V61V61V60ZM18.7939 59.9951L18.8446 58.9964L18.7939 59.9951ZM15 56H14V56H15ZM19 15V14V14V15ZM26 15V16C27.6569 16 29 17.3431 29 19H30H31C31 16.2386 28.7614 14 26 14V15ZM30 19H29V43H30H31V19H30ZM32 45V46H41V45V44H32V45ZM41 45V46C42.6569 46 44 47.3431 44 49H45H46C46 46.2386 43.7614 44 41 44V45ZM45 49H44V56H45H46V49H45ZM45 56H44C44 57.6569 42.6569 59 41 59V60V61C43.7614 61 46 58.7614 46 56H45ZM41 60V59H19V60V61H41V60ZM19 60V59C18.9444 59 18.8929 58.9989 18.8446 58.9964L18.7939 59.9951L18.7433 60.9938C18.8315 60.9983 18.9174 61 19 61V60ZM18.7939 59.9951L18.8446 58.9964C17.2605 58.916 16 57.6048 16 56H15H14C14 58.6752 16.1006 60.8597 18.7433 60.9938L18.7939 59.9951ZM15 56H16V19H15H14V56H15ZM15 19H16C16 17.3431 17.3431 16 19 16V15V14C16.2386 14 14 16.2386 14 19H15ZM19 15V16H26V15V14H19V15ZM30 43H29C29 44.6569 30.3431 46 32 46V45V44C31.4477 44 31 43.5523 31 43H30Z"
                            fill="#FFFBEB"
                            mask="url(#rotatly-logo-mask-1)"
                        />
                        <mask id="rotatly-logo-mask-2" fill="white">
                            <path d="M41 15C43.2091 15 45 16.7909 45 19V28C45 29.1046 45.8954 30 47 30H56C58.2091 30 60 31.7909 60 34V56C60 58.2091 58.2091 60 56 60H49C46.7909 60 45 58.2091 45 56V47C45 45.8954 44.1046 45 43 45H34C31.7909 45 30 43.2091 30 41V19C30 16.7909 31.7909 15 34 15H41Z" />
                        </mask>
                        <path
                            d="M41 15C43.2091 15 45 16.7909 45 19V28C45 29.1046 45.8954 30 47 30H56C58.2091 30 60 31.7909 60 34V56C60 58.2091 58.2091 60 56 60H49C46.7909 60 45 58.2091 45 56V47C45 45.8954 44.1046 45 43 45H34C31.7909 45 30 43.2091 30 41V19C30 16.7909 31.7909 15 34 15H41Z"
                            fill="#90634B"
                        />
                        <path
                            d="M45 19H46V19H45ZM56 30V29V29V30ZM60 34H59V34H60ZM60 56H61V56H60ZM56 60V59V59V60ZM49 60V61V61V60ZM45 56H44V56H45ZM30 41H29V41H30ZM34 15V14V14V15ZM41 15V16C42.6569 16 44 17.3431 44 19H45H46C46 16.2386 43.7614 14 41 14V15ZM45 19H44V28H45H46V19H45ZM47 30V31H56V30V29H47V30ZM56 30V31C57.6569 31 59 32.3431 59 34H60H61C61 31.2386 58.7614 29 56 29V30ZM60 34H59V56H60H61V34H60ZM60 56H59C59 57.6569 57.6569 59 56 59V60V61C58.7614 61 61 58.7614 61 56H60ZM56 60V59H49V60V61H56V60ZM49 60V59C47.3431 59 46 57.6569 46 56H45H44C44 58.7614 46.2386 61 49 61V60ZM45 56H46V47H45H44V56H45ZM43 45V44H34V45V46H43V45ZM34 45V44C32.3431 44 31 42.6569 31 41H30H29C29 43.7614 31.2386 46 34 46V45ZM30 41H31V19H30H29V41H30ZM30 19H31C31 17.3431 32.3431 16 34 16V15V14C31.2386 14 29 16.2386 29 19H30ZM34 15V16H41V15V14H34V15ZM45 47H46C46 45.3431 44.6569 44 43 44V45V46C43.5523 46 44 46.4477 44 47H45ZM45 28H44C44 29.6569 45.3431 31 47 31V30V29C46.4477 29 46 28.5523 46 28H45Z"
                            fill="#FFFBEB"
                            mask="url(#rotatly-logo-mask-2)"
                        />
                        <mask id="rotatly-logo-mask-3" fill="white">
                            <path d="M56 0C58.2091 0 60 1.79086 60 4V26C60 28.2091 58.2091 30 56 30H49C46.7909 30 45 28.2091 45 26V17C45 15.8954 44.1046 15 43 15H19C16.7909 15 15 13.2091 15 11V4C15 1.79086 16.7909 5.23458e-08 19 0H56Z" />
                        </mask>
                        <path
                            d="M56 0C58.2091 0 60 1.79086 60 4V26C60 28.2091 58.2091 30 56 30H49C46.7909 30 45 28.2091 45 26V17C45 15.8954 44.1046 15 43 15H19C16.7909 15 15 13.2091 15 11V4C15 1.79086 16.7909 5.23458e-08 19 0H56Z"
                            fill="#90634B"
                        />
                        <path
                            d="M60 4H61V4H60ZM56 30V31V31V30ZM45 26H44V26H45ZM15 11H14V11H15ZM19 0V-1V-1V0ZM56 0V1C57.6569 1 59 2.34315 59 4H60H61C61 1.23858 58.7614 -1 56 -1V0ZM60 4H59V26H60H61V4H60ZM60 26H59C59 27.6569 57.6569 29 56 29V30V31C58.7614 31 61 28.7614 61 26H60ZM56 30V29H49V30V31H56V30ZM49 30V29C47.3431 29 46 27.6569 46 26H45H44C44 28.7614 46.2386 31 49 31V30ZM45 26H46V17H45H44V26H45ZM43 15V14H19V15V16H43V15ZM19 15V14C17.3431 14 16 12.6569 16 11H15H14C14 13.7614 16.2386 16 19 16V15ZM15 11H16V4H15H14V11H15ZM15 4H16C16 2.34315 17.3431 1 19 1V0V-1C16.2386 -1 14 1.23858 14 4H15ZM19 0V1H56V0V-1H19V0ZM45 17H46C46 15.3431 44.6569 14 43 14V15V16C43.5523 16 44 16.4477 44 17H45Z"
                            fill="#FFFBEB"
                            mask="url(#rotatly-logo-mask-3)"
                        />
                    </svg>
                    <span class="header-title">Rotatly</span>
                </a>
                <nav class="header-nav">
                    <a class="nav-button" href="{% url 'create' %}">
                        <i class="fa-solid fa-border-all nav-icon" aria-hidden="true"></i>
                        <span>Create Puzzle</span>
                    </a>
                    <button class="nav-button" type="button" disabled>
                        <i class="fa-solid fa-trophy nav-icon" aria-hidden="true"></i>
                        <span>Leaderboard</span>
                    </button>
                    <a class="nav-button" href="{% url 'profile' %}">
                        <i class="fa-regular fa-user nav-icon" aria-hidden="true"></i>
                        <span>Profile</span>
                    </a>
                    <div class="nav-divider" aria-hidden="true"></div>
                    <a class="nav-button nav-button--logout" href="{% url 'login' %}">
                        <i class="fa-solid fa-right-from-bracket nav-icon" aria-hidden="true"></i>
                        <span>Logout</span>
                    </a>
                </nav>
            </div>
        </header>

        <header class="game-header game-header--mobile">
            <div class="mobile-nav-left">
                <button
                    class="icon-button"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#instructions-modal"
                    aria-label="Instructions"
                >
                    <i class="fa-regular fa-circle-question" aria-hidden="true"></i>
                </button>
                <a
                    href="mailto:support@rotatly.com"
                    target="_blank"
                    rel="noopener"
                    class="icon-button"
                    aria-label="Contact Us"
                >
                    <i class="fa-regular fa-envelope" aria-hidden="true"></i>
                </a>
                <button class="icon-button" type="button" id="share-icon" aria-label="Share">
                    <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
                </button>
                <a
                    href="https://github.com/proy87/rotatly"
                    target="_blank"
                    rel="noopener"
                    class="icon-button"
                    aria-label="View on GitHub"
                >
                    <i class="fa-brands fa-github" aria-hidden="true"></i>
                </a>
            </div>
            <button class="icon-button" type="button" aria-label="Menu" data-action="open-menu">
                <i class="fa-solid fa-bars" aria-hidden="true"></i>
            </button>
        </header>

        <div class="mobile-menu-overlay" id="mobile-menu-overlay" hidden>
            <div class="mobile-menu" role="dialog" aria-modal="true">
                <header class="mobile-menu-header">
                    <span class="mobile-menu-title">Rotatly</span>
                    <button class="icon-button" type="button" aria-label="Close menu" data-action="close-menu">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    </button>
                </header>
                <div class="mobile-menu-body">
                    <span class="mobile-menu-username">{% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}</span>
                    <nav class="mobile-menu-links" aria-label="Mobile navigation">
                        <a class="mobile-menu-button" href="{% url 'profile' %}">
                            <i class="fa-regular fa-user mobile-menu-icon" aria-hidden="true"></i>
                            <span>Profile</span>
                        </a>
                        <button class="mobile-menu-button" type="button" disabled>
                            <i class="fa-solid fa-trophy mobile-menu-icon" aria-hidden="true"></i>
                            <span>Leaderboard</span>
                        </button>
                        <a class="mobile-menu-button" href="{% url 'create' %}">
                            <i class="fa-solid fa-border-all mobile-menu-icon" aria-hidden="true"></i>
                            <span>Create Puzzle</span>
                        </a>
                    </nav>
                    <a class="mobile-menu-button mobile-menu-button--logout" href="{% url 'login' %}">
                        <i class="fa-solid fa-right-from-bracket mobile-menu-icon" aria-hidden="true"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>

        <main class="game-main">
            <section class="game-hero">
                <h1 class="puzzle-title">{% block title %}{% endblock %}</h1>
                {% block calendar %}{% endblock %}

                <div id="target-outline-container" class="target-outline">
                    <span class="target-label">Target outline</span>
                    <div class="target-preview">
                        <div class="outline-container">
                            {% include './includes/board.html' with board=target_preview is_outline=True skip_grid=False %}
                        </div>
                    </div>
                </div>

                <div class="moves-hint" aria-label="Minimum moves">
                    <span class="moves-hint-text">Minimum number of moves to solve:</span>
                    <span class="moves-hint-value">{{ game.moves_min_num }}</span>
                </div>
            </section>

            <section class="game-board-row">
                <div id="game-board-container" class="game-board-container">
                    <div id="game-container" class="game-board">
                        <div class="game-grid">
                            {% include './includes/board.html' %}
                        </div>
                        <div class="game-nodes">
                            {% include './includes/nodes.html' %}
                        </div>
                    </div>
                    <div id="win-overlay" class="win-overlay" style="display: none;" data-display="flex">
                        <span id="win-text" class="win-text"></span>
                    </div>
                </div>
            </section>

            <section class="game-controls">
                <button id="undo-move" class="control-button control-button--undo" disabled>
                    <i class="fa-solid fa-rotate-left control-icon" aria-hidden="true"></i>
                    <span>Undo</span>
                </button>
                <button id="restart-game" class="control-button control-button--restart" disabled>
                    <i class="fa-solid fa-rotate-right control-icon" aria-hidden="true"></i>
                    <span>Restart</span>
                </button>
            </section>

            <section class="game-stats">
                <div class="stats-card">
                    <div class="stats-header">
                        <h2 class="stats-title">Rotatly #{{ game.index }}</h2>
                        {% if current_date %}<span class="stats-date">{{ current_date }}</span>{% endif %}
                    </div>
                    <div id="stats-initial" class="stats-body">
                        <p class="stats-status">Didn't try today</p>
                        <p class="stats-status">It's never too late to start!</p>
                    </div>
                    <div id="stats-playing" class="stats-body" style="display: none;">
                        <p class="stats-status">Rotating...</p>
                        <p class="stats-moves">
                            Moves made: <strong id="moves-made-num">0</strong>
                        </p>
                    </div>
                    <div id="share-container" class="share-card">
                        <button id="copy-result" class="stats-share-button" type="button">
                            <i class="fa-solid fa-share-nodes stats-share-icon" aria-hidden="true"></i>
                            <span>Share result</span>
                        </button>
                        <div id="copy-toast" class="copy-toast" style="display: none;">
                            Copied! Share anywhere.
                        </div>
                        <textarea id="shareable-text" rows="4" aria-label="Shareable text" style="display: none;"></textarea>
                    </div>
                    <span id="moves-sequence" style="display: none;">no moves</span>
                </div>
                {% block prev_next_navigation %}{% endblock %}
            </section>
        </main>

        <footer class="game-footer">
            <div class="footer-left">
                <span class="footer-text">All rights reserved 2026</span>
                <span class="footer-divider" aria-hidden="true"></span>
                <a class="footer-link" href="#">Privacy Policy</a>
            </div>
            <div class="footer-icons" aria-label="Footer actions">
                <a
                    class="footer-icon-button"
                    href="mailto:support@rotatly.com"
                    aria-label="Mail"
                >
                    <i class="fa-regular fa-envelope" aria-hidden="true"></i>
                </a>
                <button class="footer-icon-button" type="button" aria-label="Share">
                    <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
                </button>
                <a
                    class="footer-icon-button"
                    href="https://github.com/proy87/rotatly"
                    target="_blank"
                    rel="noopener"
                    aria-label="GitHub"
                >
                    <i class="fa-brands fa-github" aria-hidden="true"></i>
                </a>
            </div>
        </footer>
    </div>
{% endblock %}
{% block modal %}
    <div class="modal fade" id="instructions-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fa fa-circle-question me-2"></i>How to Play
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                <p>Make the correct outline using the fewest number of rotations.</p>
                <p>Rotate the cells until you get the correct outline.</p>
                <p>An outline consists of blocks that are separated by a black border.</p>
                <p>Letters/colors within the same block should be the same.</p>
                <p>If the block in the target outline is colored, that exact color should be in that block.</p>
                <div class="instructions-controls">
                    <ul>
                        <li><i class="fa fa-arrow-rotate-right rotate-icon"></i> Click a blue node to rotate clockwise.</li>
                        <li>
                            <i class="fa fa-arrow-rotate-left rotate-icon"></i> Press and hold, or right-click a blue node,
                                to rotate counterclockwise.
                        </li>
                        <li>
                            <i class="fa fa-arrows-alt rotate-icon"></i> Slide across cells (to determine direction, you
                            need to slide across three cells).
                        </li>
                    </ul>
                </div>
                <hr>
                <div>
                    Have suggestions or feedback about Rotatly?<br>
                    We’d love to hear from you: <a href="mailto:support@rotatly.com">support@rotatly.com</a>
                </div>
            </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        let game_index = {{ game.index }};
        let moves_max_num = {{ moves_max_num }};
        let moves_min_num = {{ game.moves_min_num }};
        let outline = {{ outline_dumped|safe }};
        let cw_symbol = '{{ cw_symbol }}';
        let ccw_symbol = '{{ ccw_symbol }}';

        let pre_moves = {{ pre_moves_dumped|safe }};
        let canonical_url = '{{ canonical_url }}';

        let track_url = '{% url "track" %}';
    </script>
    {% if False %}
    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- gif.js -->
    <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
    <script>
        $(function () {
            function animate($node, cw, step) {
                let row = $node.data('row');
                let col = $node.data('col');
                let $tl = $(`#cell-${row}-${col}`);
                let $tr = $(`#cell-${row}-${col + 1}`);
                let $br = $(`#cell-${row + 1}-${col + 1}`);
                let $bl = $(`#cell-${row + 1}-${col}`);
                $tl.css('transform', (cw ? 'translateX' : 'translateY') + `(${step}px)`)
                $tr.css('transform', (cw ? 'translateY' : 'translateX') + (cw ? `(${step}px)` : `(-${step}px)`))
                $br.css('transform', (cw ? 'translateX' : 'translateY') + `(-${step}px)`)
                $bl.css('transform', (cw ? 'translateY' : 'translateX') + (cw ? `(-${step}px)` : `(${step}px)`))
            }

            document.getElementById("start").addEventListener("click", async () => {
                const target = document.getElementById("board");
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    workerScript: '{% static "js/gif.worker.js" %}'
                });
//dict(square=((2, 3, 3, 4), (4, 4, 3, 4), (2, 1, 1, 3), (1, 2, 2, 1)), min=9, index=10, disabled_nodes=[5, 9]),

                let steps = [[1, 'CW'], [6, 'CCW'], [2, 'CCW'], [1, 'CW'], [8, 'CW'], [7, 'CCW'], [6, 'CCW'], [4, 'CW'], [8, 'CCW']];

                let canvas = await html2canvas(target);
                gif.addFrame(canvas, {delay: 1000});
                for (let i = 0; i < steps.length; i++) {
                    let row = Math.floor((steps[i][0] - 1) / 3);
                    let col = (steps[i][0] - 1) % 3;
                    let $node = $('[data-row=' + row + '][data-col=' + col + ']').addClass('highlight').text(steps[i][1] === 'CW' ? '↻' : '↺');
                    for (let j = 7; j <= cell_width; j += 7) {
                        animate($node, steps[i][1] === 'CW', j)

                        let d;
                        if (i === steps.length - 1) {
                            d = (j === cell_width) ? 3000 : 500 / 11;
                        } else {
                            d = (j === cell_width) ? 1000 : 500 / 11;
                        }

                        if (j === cell_width) {
                            $node.removeClass('highlight').text($node.data('node'))
                            let $tl = $(`#cell-${row}-${col}`).css('transform', 'none');
                            let $tr = $(`#cell-${row}-${col + 1}`).css('transform', 'none');
                            let $br = $(`#cell-${row + 1}-${col + 1}`).css('transform', 'none');
                            let $bl = $(`#cell-${row + 1}-${col}`).css('transform', 'none');
                            $.rotate(row, col, steps[i][1] === 'CW')
                        }
                        const canvas = await html2canvas(target);
                        gif.addFrame(canvas, {delay: d});
                    }

                }

                gif.on("finished", blob => {
                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(blob);
                    document.body.appendChild(img);
                });

                gif.render();
            });
        })
    </script>
{% endif %}
{% block additional_js %}{% endblock %}
<script src="{% static 'js/game-ui.js' %}"></script>
<script src="{% static 'js/core.min.js' %}"></script>
<script src="{% static 'js/game.js' %}"></script>
{% endblock %}

